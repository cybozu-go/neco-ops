groups:
  - name: kube-apiserver.rules
    rules:
      - expr: |
          histogram_quantile(0.99, sum(rate(apiserver_request_duration_seconds_bucket{job="kubernetes-apiservers"}[5m])) without(instance, pod))
        labels:
          quantile: "0.99"
        record: cluster_quantile:apiserver_request_duration_seconds:histogram_quantile
      - expr: |
          histogram_quantile(0.9, sum(rate(apiserver_request_duration_seconds_bucket{job="kubernetes-apiservers"}[5m])) without(instance, pod))
        labels:
          quantile: "0.9"
        record: cluster_quantile:apiserver_request_duration_seconds:histogram_quantile
      - expr: |
          histogram_quantile(0.5, sum(rate(apiserver_request_duration_seconds_bucket{job="kubernetes-apiservers"}[5m])) without(instance, pod))
        labels:
          quantile: "0.5"
        record: cluster_quantile:apiserver_request_duration_seconds:histogram_quantile
  - name: kube-apiserver
    rules:
      - alert: K8sAPIServersDegraded
        expr: count(up{job="kubernetes-apiservers"} == 1) < 3
        labels:
          severity: warning
        for: 10m
        annotations:
          summary: The number of kube-apiserver is less than 3.
      - alert: K8sAPIServersDegraded
        expr: absent(up{job="kubernetes-apiservers"} == 1)
        labels:
          severity: critical
        for: 10m
        annotations:
          summary: No kube-apiserver is running.
  - name: applications CD
    rules:
      - alert: AppOutOfSync
        expr: argocd_app_sync_status{sync_status="Synced"} == 0
        for: 20m
        labels:
          severity: page
        annotations:
          summary: "{{ $labels.exported_name }} is out-of-sync."
          runbook: "See https://github.com/cybozu-go/neco-apps/blob/master/DEVELOPMENT.md#out-of-sync"
  - name: etcd
    rules:
      - alert: DatabaseSpaceExceeded
        expr: etcd_mvcc_db_total_size_in_bytes/etcd_server_quota_backend_bytes > 0.80
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.instance }}, {{ $labels.job }} of etcd DB space uses more than 80%"
          runbook: "Please consider manual compaction and defrag. https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/maintenance.md"
      - alert: DatabaseSpaceExceeded
        expr: etcd_mvcc_db_total_size_in_bytes/etcd_server_quota_backend_bytes > 0.90
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.instance }}, {{ $labels.job }} of etcd DB space uses more than 90%"
          runbook: "Please consider manual compaction and defrag. https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/maintenance.md"
      - alert: LogicalDatabaseUsageIncreaseRapidly
        expr: delta(etcd_mvcc_db_total_size_in_use_in_bytes[1h]) > 30000000
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "{{ $labels.instance }}, {{ $labels.job }} of etcd DB space increases {{ $value | humanize }}B/h"
          runbook: "Please consider to find root causes, and solve the problems"
      - alert: ArgoCDDown
        expr: |
          absent(up{job="argocd"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: BootserverEtcdMissing
        expr: absent(up{job="bootserver-etcd"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: CalicoNodeDown
        expr: |
          absent(up{job="calico-node"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: CKEEtcdMissing
        expr: absent(up{job="cke-etcd"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: ContourDown
        expr: |
          absent(up{job="contour"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: ExternalDNSDown
        expr: |
          absent(up{job="external-dns"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: IngressDown
        expr: |
          absent(up{job="ingress"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: KubernetesCAdvisorDown
        expr: |
          absent(up{job="kubernetes-cadvisor"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: KubernetesNodesDown
        expr: |
          absent(up{job="kubernetes-nodes"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: MetalLBDown
        expr: |
          absent(up{job="metallb"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: MonitorHWDown
        expr: |
          absent(up{job="metallb"} == 1)
        labels:
          severity: critical
        for: 10m
      - alert: TeleportDown
        expr: |
          absent(up{job="teleport"} == 1)
        labels:
          severity: critical
        for: 10m
