JSONNET_VERSION := 0.17.0
YQ_VERSION := 4.6.3
AUTOGEN_COMMENT := This file is automatically generated from a template. Please do not edit.

ROOT_DIR := $(shell git rev-parse --show-toplevel)
BINDIR := $(abspath $(CURDIR)/bin)
JSONNET := $(BINDIR)/jsonnet
JSONNETFMT := $(BINDIR)/jsonnetfmt
YQ := $(BINDIR)/yq

DOWNLOAD_DIR := $(ROOT_DIR)/download
JSONNET_DLPATH := $(DOWNLOAD_DIR)/jsonnet-v$(JSONNET_VERSION).tar.gz
YQ_DLPATH := $(DOWNLOAD_DIR)/yq-v$(YQ_VERSION).tar.gz

TEMP_DIR := /tmp/team-management

WGET := wget --retry-connrefused --no-verbose
WGET_PATH := $(shell which wget || echo wget-install)

.PHONY: all
all: team-management

.PHONY: team-management
team-management:
	# Cleanup existing files
	for i in $$(ls -d ../base/*/); do \
		if ! echo $$i | grep -E '/(common|neco|neco-readonly|sandbox)/' > /dev/null; then \
			rm -rf $$i; \
		fi; \
	done

	# Generate manifests
	mkdir -p $(TEMP_DIR)
	$(JSONNET) team-management.jsonnet > $(TEMP_DIR)/team-management.json
	for i in $$(cat $(TEMP_DIR)/team-management.json | jq -r 'keys | .[]'); do \
		echo $$i; \
		mkdir -p $(ROOT_DIR)/$$(dirname $$i); \
		cat $(TEMP_DIR)/team-management.json | $(YQ) eval ".[\"$$i\"] | .[0] headComment=\"$(AUTOGEN_COMMENT)\" | .[] | splitDoc" - --prettyPrint > $(ROOT_DIR)/$$i; \
	done
	rm -rf $(TEMP_DIR)

.PHONY: format
format:
	mkdir -p $(TEMP_DIR)
	for i in $$(find . -name '*.json'); do \
		echo $$i; \
		jq . $$i > $(TEMP_DIR)/$$i; \
		mv $(TEMP_DIR)/$$i $$i; \
	done
	rm -rf $(TEMP_DIR)
	for i in $$(find . -name '*.jsonnet'); do \
		echo $$i; \
		$(JSONNETFMT) -i $$i; \
	done
	for i in $$(find . -name '*.libsonnet'); do \
		echo $$i; \
		$(JSONNETFMT) -i $$i; \
	done

.PHONY: validation
validation: format all
	if ! test -z "$$(git status -s)"; then \
		git status; \
		exit 1; \
	fi

.PHONY: setup
setup: $(JSONNET) $(YQ)

$(JSONNET): $(JSONNET_DLPATH)
	mkdir -p $(BINDIR)
	tar zxf $(JSONNET_DLPATH) -C $(BINDIR)

$(JSONNET_DLPATH): $(WGET_PATH)
	mkdir -p $(DOWNLOAD_DIR)
	$(WGET) -O $@ https://github.com/google/jsonnet/releases/download/v$(JSONNET_VERSION)/jsonnet-bin-v$(JSONNET_VERSION)-linux.tar.gz

$(YQ): $(YQ_DLPATH)
	mkdir -p $(BINDIR)
	tar zxf $(YQ_DLPATH) -O ./yq_linux_amd64 > $@
	chmod +x $@

$(YQ_DLPATH): $(WGET_PATH)
	mkdir -p $(DOWNLOAD_DIR)
	$(WGET) -O $@ https://github.com/mikefarah/yq/releases/download/v$(YQ_VERSION)/yq_linux_amd64.tar.gz

.PHONY: wget-install
$(WGET_PATH):
	$(SUDO) apt-get update && $(SUDO) apt-get -y install wget; \

.PHONY: clean
clean:
	rm -rf $(BINDIR)
	rm -rf $(DOWNLOAD_DIR)
